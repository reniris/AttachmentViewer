<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Attachments image viewer</title>
    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <style>
      html, body, textarea {
          width: 100%;
          height: 100vh;
          padding: 0;
          margin: 0;
      }
      #error {
          display: none;
          background: red;
          color: white;
          padding: 20px;
          text-align: center;
      }
      #viewer {
          display: none;
          text-align: center;
      }
      img {
          width: 100%;
          height: 100%;
          object-fit: contain;
      }
    </style>
  </head>
  <body>
    <div id="error"></div>
    <img id="viewer" />
    <script>
      var viewer = document.getElementById('viewer');
      function showError(msg) {
        var el = document.getElementById('error')
        if (!msg) {
          el.style.display = 'none';
        } else {
          el.innerHTML = msg;
          el.style.display = 'block';
        }
      }
      grist.ready({
        columns: [{ name: "ImageFile", title: 'Image File', type: 'Attachments'}],
        requiredAccess: 'read table'
      });
      // Helper function that reads first value from a table with a single column.
      function singleColumn(record) {
        const columns = Object.keys(record || {}).filter(k => k !== 'id');
        return columns.length === 1 ? record[columns[0]] : undefined;
      }
      grist.onNewRecord(() => {
        showError("");
        viewer.style.display = 'none';
      });
      
      grist.onRecord(async (record) => {
        console.log('Debug Massage onRecord Start');  
        const id = record.ImageFile[0];  // get an id of an attachment - there could be several
                                // in a cell, for this example we just take the first.
        console.log('Debug Massage onRecord id ${id}');
        
        const tokenInfo = await grist.docApi.getAccessToken({readOnly: true});
        const src = `${tokenInfo.baseUrl}/attachments/${id}/download?auth=${tokenInfo.token}`;
        
        //viewer.src = src;
        
        //const img = document.getElementById('viewer');
        //img.setAttribute('src', src);       
        
        console.log('Debug Massage onRecord tokenInfo ${tokenInfo.baseUrl}');
        
        if (id === undefined) {
          showError("Please choose a column to show in the Creator Panel.");
        } else {
          showError("");
          if (!src) {
            viewer.style.display = 'none';
          } else {
            viewer.src = src;
            viewer.style.display = 'block';
          }
        }
        console.log('Debug Massage onRecord End')
      });
    </script>
  </body>
</html>
